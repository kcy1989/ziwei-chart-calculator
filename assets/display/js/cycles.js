'use strict';

/**
 * Major and Annual Cycles Display Module
 * 
 * Corresponding CSS: assets/display/css/cycles.css
 */

(function() {
    function getAdapterModule(name) {
        const adapter = window.ziweiAdapter;
        if (!adapter) {
            return null;
        }
        if (typeof adapter.getModule === 'function') {
            return adapter.getModule(name);
        }
        const modules = adapter.modules || {};
        return modules[name] || null;
    }

    /**
     * Initialize the major/annual cycle panel displayed under the chart.
     * @param {Object} lifeCycleData Life cycle payload generated by chart.js draw()
     * @param {HTMLElement} grid The 4x4 grid element for palace highlighting
     * @param {Object} [palaceInteraction=null] API returned by initializePalaceInteraction
     * @returns {HTMLElement|null} Rendered panel element or null if data missing
     */
    function initializeCyclePanel(lifeCycleData = {}, grid, palaceInteraction = null) {
        const majorCycles = Array.isArray(lifeCycleData?.majorCycles) ? lifeCycleData.majorCycles : [];
        const palaceData = lifeCycleData?.palaceData || {};
        const timeIndex = lifeCycleData?.timeIndex;

        console.log('Cycles.js initialized:', { majorCycles, palaceData, timeIndex, palaceInteraction, lifeCycleData });

        if (!grid || majorCycles.length === 0) {
            return null;
        }

        const panel = document.createElement('div');
        panel.className = 'ziwei-cycle-panel';

        // Major cycle section
        const majorSection = document.createElement('div');
        majorSection.className = 'ziwei-cycle-section';
        panel.appendChild(majorSection);

        const majorLabel = document.createElement('div');
        majorLabel.className = 'ziwei-cycle-label';
        majorLabel.textContent = '大限';
        majorSection.appendChild(majorLabel);

        const majorRow = document.createElement('div');
        majorRow.className = 'ziwei-cycle-row ziwei-major-cycle-row';
        majorSection.appendChild(majorRow);

        // Annual cycle section
        const annualSection = document.createElement('div');
        annualSection.className = 'ziwei-cycle-section';
        panel.appendChild(annualSection);

        const annualLabel = document.createElement('div');
        annualLabel.className = 'ziwei-cycle-label';
        annualLabel.textContent = '流年';
        annualLabel.style.display = 'none';
        annualSection.appendChild(annualLabel);

        const annualRow = document.createElement('div');
        annualRow.className = 'ziwei-cycle-row ziwei-annual-cycle-row';
        annualRow.style.display = 'none';
        annualSection.appendChild(annualRow);

    let activeMajorButton = null;
        let isProcessingCycleClick = false;

    // Fixed clockwise labels for 大限 display starting at 命宮
    const MAJOR_LABELS = ['大命','大父','大福','大田','大事','大友','大遷','大疾','大財','大子','大夫','大兄'];

        const clearCycleState = () => {
            // Don't clear if we're in the middle of processing a cycle button click
            if (isProcessingCycleClick) {
                console.log('clearCycleState: skipping because cycle click in progress');
                return;
            }
            
            console.log('clearCycleState: clearing all cycle state');
            if (activeMajorButton) {
                activeMajorButton.classList.remove('ziwei-cycle-button-active');
            }
            activeMajorButton = null;
            annualRow.innerHTML = '';
            annualRow.style.display = 'none';
            annualLabel.style.display = 'none';
            window.ziweiChartHelpers?.clearMajorCycleStars?.();
            window.ziweiChartHelpers?.clearMajorCycleMutations?.();
            window.ziweiChartHelpers?.clearMajorMingLabel?.();
            // Also clear any multi-palace major-cycle labels
            window.ziweiChartHelpers?.clearMajorCycleLabels?.();
            // Clear any multi-palace annual-cycle labels
            window.ziweiChartHelpers?.clearAnnualCycleLabels?.();
            window.ziweiChartHelpers?.clearAnnualCycleMutations?.();
            window.ziweiChartHelpers?.clearAnnualMingLabel?.();
        };

        const highlightPalace = (palaceIndex) => {
            if (palaceInteraction && typeof palaceInteraction.highlight === 'function') {
                palaceInteraction.highlight(palaceIndex);
                return;
            }

            // Fallback: find cell and click it
            const fallbackCell = grid.querySelector(`.ziwei-cell[data-branch-index="${palaceIndex}"]`);
            if (fallbackCell) {
                fallbackCell.click();
            }
        };

        /**
         * Get earthly branch (地支) character for a given year
         * Uses window.ziweiConstants.BRANCH_NAMES for consistent naming
         * @param {number} year The year
         * @returns {string} Branch character (子-亥)
         */
        const getEarthlyBranchChar = (year) => {
            const branchNames = window?.ziweiConstants?.BRANCH_NAMES;
            if (!Array.isArray(branchNames) || branchNames.length !== 12) {
                throw new Error('[cycles.js] BRANCH_NAMES not available from constants');
            }
            const basicModule = getAdapterModule('basic');
            if (basicModule && typeof basicModule.getEarthlyBranchIndex === 'function') {
                const branchIndex = basicModule.getEarthlyBranchIndex(year);
                return branchNames[branchIndex] || '';
            }
            return '';
        };
        /**
         * Convert branch character to branch index (0-11)
         * Uses window.ziweiConstants.BRANCH_NAMES for consistent lookup
         * @param {string} branchChar Branch character (子-亥)
         * @returns {number} Branch index (0-11), or -1 if not found
         */
        const branchCharToIndex = (branchChar) => {
            const branchNames = window?.ziweiConstants?.BRANCH_NAMES;
            if (!Array.isArray(branchNames) || branchNames.length !== 12) {
                throw new Error('[cycles.js] BRANCH_NAMES not available from constants');
            }
            return branchNames.indexOf(branchChar);
        };
        const getPalaceStemBranch = (palaceIndex) => {
            if (palaceData && palaceData[palaceIndex]) {
                const palace = palaceData[palaceIndex];
                return (palace.stem || '') + (palace.branchZhi || '');
            }
            return '';
        };

        // Extract lunarYear from window.ziweiChartData (set by chart.js) or grid data attributes
        const lunarYear = (function() {
            if (Number.isInteger(window.ziweiChartData?.lunarYear)) {
                return window.ziweiChartData.lunarYear;
            }
            const gridLunarYear = grid?.dataset?.lunarYear;
            if (gridLunarYear && /^\d+$/.test(gridLunarYear)) {
                return parseInt(gridLunarYear, 10);
            }
            return null;
        })();

        console.log('Year extraction result:', { lunarYear, ziweiChartDataAvailable: !!window.ziweiChartData, gridDataset: grid?.dataset });

        /**
         * Get heavenly stem (天干) character for a given year
         * Uses window.ziweiConstants.STEM_NAMES for consistent naming
         * @param {number} year The year
         * @returns {string} Stem character (甲-癸)
         */
        const getHeavenlyStemChar = (year) => {
            const stemNames = window?.ziweiConstants?.STEM_NAMES;
            if (!Array.isArray(stemNames) || stemNames.length !== 10) {
                throw new Error('[cycles.js] STEM_NAMES not available from constants');
            }
            const basicModule = getAdapterModule('basic');
            if (basicModule && typeof basicModule.getHeavenlyStemIndex === 'function') {
                const stemIndex = basicModule.getHeavenlyStemIndex(year);
                return stemNames[stemIndex] || '';
            }
            return '';
        };

        /**
         * Get the stem-branch (天干地支) characters for a given year
         * @param {number} year The year
         * @returns {string} Stem-branch combination (e.g., "甲子")
         */
        const getStemBranchForYear = (year) => {
            return getHeavenlyStemChar(year) + getEarthlyBranchChar(year);
        };

        const renderAnnualRow = (cycle) => {
            annualRow.innerHTML = '';
            window.ziweiChartHelpers?.clearAnnualMingLabel?.();
            window.ziweiChartHelpers?.clearAnnualCycleLabels?.();
            window.ziweiChartHelpers?.clearAnnualCycleMutations?.();

            // Strict requirement: must have lunarYear to compute actual years.
            if (!Number.isInteger(lunarYear)) {
                console.error('ziweiCycles: unable to render annual years — missing lunarYear', { 
                    lunarYear, 
                    ziweiChartData: window.ziweiChartData,
                    gridDataset: grid?.dataset 
                });
                // Do not show the annual row when data insufficient (no fallback assumptions).
                annualRow.style.display = 'none';
                annualLabel.style.display = 'none';
                return;
            }

            for (let offset = 0; offset < 10; offset++) {
                const age = cycle.startAge + offset;
                const annualBtn = document.createElement('button');
                annualBtn.type = 'button';
                annualBtn.className = 'ziwei-cycle-button ziwei-annual-cycle-button';
                annualBtn.dataset.age = String(age);
                annualBtn.dataset.cycleIndex = String(cycle.cycleIndex);

                // Compute displayed year: lunarYear + startAge + offset - 1
                // Example: lunarYear=1989, cycle 12-21, offset=0 => 1989+12-1=2000
                const displayYear = lunarYear + cycle.startAge + offset - 1;
                const stemBranch = getStemBranchForYear(displayYear);
                
                // Create button content: year on top, stem-branch + age on bottom
                const yearSpan = document.createElement('div');
                yearSpan.className = 'ziwei-annual-year';
                yearSpan.textContent = `${displayYear}年`;
                
                const stemBranchSpan = document.createElement('div');
                stemBranchSpan.className = 'ziwei-annual-stem-branch';
                stemBranchSpan.textContent = `${stemBranch}${age}歲`;
                
                annualBtn.appendChild(yearSpan);
                annualBtn.appendChild(stemBranchSpan);
                annualBtn.dataset.year = String(displayYear);

                // Add click event to annual button for highlighting palace and showing annual stars
                annualBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    console.log('Annual button clicked:', { displayYear, stemBranch, age });

                    // Extract branch character from stem-branch (last character is branch)
                    const stemChar = stemBranch.charAt(0);
                    const branchChar = stemBranch.charAt(1);
                    const branchIndex = branchCharToIndex(branchChar);
                    console.log('Branch info:', { branchChar, branchIndex });

                    if (branchIndex >= 0 && branchIndex < 12) {
                        // Prevent clear callbacks from wiping state while we update the view
                        isProcessingCycleClick = true;

                        // Highlight this annual button (add active class)
                        const allAnnualButtons = annualRow.querySelectorAll('.ziwei-annual-cycle-button');
                        allAnnualButtons.forEach(btn => {
                            btn.classList.remove('ziwei-cycle-button-active');
                        });
                        annualBtn.classList.add('ziwei-cycle-button-active');

                        // Highlight the palace based on branch index
                        highlightPalace(branchIndex);

                        // Show annual stars - ADD to existing major cycle stars, don't replace them
                        window.ziweiChartHelpers?.showAnnualCycleStars?.({
                            age: age,
                            year: displayYear,
                            branchIndex: branchIndex,
                            stemChar: stemChar,
                            timeIndex: timeIndex
                        });

                        // Also render the clockwise sequence of annual labels (skip the main 年命 palace)
                        const ANNUAL_LABELS = ['流父','流福','流田','流事','流友','流遷','流疾','流財','流子','流夫','流兄'];
                        window.ziweiChartHelpers?.setAnnualCycleLabels?.(branchIndex, ANNUAL_LABELS);

                        // Allow deferred clear callbacks to run after highlight completes
                        setTimeout(() => {
                            isProcessingCycleClick = false;
                        }, 100);
                    }
                });

                annualRow.appendChild(annualBtn);
            }
            annualRow.style.display = 'grid';
            annualLabel.style.display = 'block';
        };

        const handleMajorCycleSelection = (cycle, stemBranch) => {
            if (!cycle) return;

            const palace = palaceData?.[cycle.palaceIndex] || null;
            const cycleStem = palace?.stem || (stemBranch ? stemBranch.charAt(0) : '');
            const cycleBranchIndex = palace?.index;

            window.ziweiChartHelpers?.showMajorCycleStars?.({ 
                cycle, 
                stem: cycleStem,
                branchIndex: cycleBranchIndex,
                timeIndex: timeIndex,
                palaceData: palaceData
            });
            window.ziweiChartHelpers?.applyMajorCycleMutations?.(cycleStem);
            // Render the full clockwise sequence of 大限 labels around 命宮
            if (Number.isInteger(cycleBranchIndex)) {
                window.ziweiChartHelpers?.setMajorCycleLabels?.(cycleBranchIndex, MAJOR_LABELS);
            }
        };

        majorCycles.forEach((cycle) => {
            const stemBranch = getPalaceStemBranch(cycle.palaceIndex);
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'ziwei-cycle-button ziwei-major-cycle-button';
            const labelText = stemBranch ? `${stemBranch}限` : '大限';
            btn.dataset.cycleIndex = String(cycle.cycleIndex);
            btn.dataset.palaceIndex = String(cycle.palaceIndex);
            btn.dataset.ageRange = cycle.ageRange;

            const labelSpan = document.createElement('span');
            labelSpan.className = 'ziwei-cycle-button-label';
            labelSpan.textContent = labelText;
            btn.appendChild(labelSpan);

            const ageSpan = document.createElement('span');
            ageSpan.className = 'ziwei-cycle-button-age';
            ageSpan.textContent = cycle.ageRange;
            btn.appendChild(ageSpan);

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                console.log('Cycle button clicked:', { cycleIndex: cycle.cycleIndex, palaceIndex: cycle.palaceIndex, stemBranch });

                // Set flag to prevent clearCycleState from running during our click handling
                isProcessingCycleClick = true;

                // Remove active class from all buttons first
                const allButtons = majorRow.querySelectorAll('.ziwei-cycle-button');
                allButtons.forEach(b => {
                    b.classList.remove('ziwei-cycle-button-active');
                });

                // Add active class to clicked button
                console.log('Adding active class to button:', stemBranch);
                btn.classList.add('ziwei-cycle-button-active');
                activeMajorButton = btn;
                
                // Verify class was added
                console.log('Button classes after click:', btn.className);
                console.log('Has active class:', btn.classList.contains('ziwei-cycle-button-active'));

                highlightPalace(cycle.palaceIndex);
                renderAnnualRow(cycle);
                handleMajorCycleSelection(cycle, stemBranch);

                // Reset flag after a short delay to allow palace highlight to complete
                setTimeout(() => {
                    isProcessingCycleClick = false;
                }, 100);
            });

            majorRow.appendChild(btn);
        });

        // Hook into palace interaction to clear cycle state when clicking center
        if (grid && palaceInteraction && typeof palaceInteraction.onClear === 'function') {
            console.log('Registering onClear callback');
            palaceInteraction.onClear(() => {
                console.log('onClear callback invoked');
                clearCycleState();
            });
        } else if (grid) {
            console.log('Fallback: registering grid click handler');
            // Fallback: listen for center cell clicks
            grid.addEventListener('click', (e) => {
                const cellElement = e.target.closest('.ziwei-cell');
                if (!cellElement || cellElement.classList.contains('ziwei-center-big')) {
                    console.log('Center cell clicked, clearing state');
                    clearCycleState();
                }
            });
        }

        return panel;
    }

    window.ziweiCycles = {
        initializeCyclePanel
    };
})();

