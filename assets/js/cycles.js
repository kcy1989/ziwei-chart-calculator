'use strict';

(function() {
    /**
     * Initialize the major/annual cycle panel displayed under the chart.
     * @param {Object} lifeCycleData Life cycle payload generated by chart.js draw()
     * @param {HTMLElement} grid The 4x4 grid element for palace highlighting
     * @param {Object} [palaceInteraction=null] API returned by initializePalaceInteraction
     * @returns {HTMLElement|null} Rendered panel element or null if data missing
     */
    function initializeCyclePanel(lifeCycleData = {}, grid, palaceInteraction = null) {
        const majorCycles = Array.isArray(lifeCycleData?.majorCycles) ? lifeCycleData.majorCycles : [];
        const palaceData = lifeCycleData?.palaceData || {};
        const timeIndex = lifeCycleData?.timeIndex;
        
        console.log('Cycles.js initialized:', { majorCycles, palaceData, timeIndex, palaceInteraction });
        
        if (!grid || majorCycles.length === 0) {
            return null;
        }

        const panel = document.createElement('div');
        panel.className = 'ziwei-cycle-panel';

        // Major cycle section
        const majorSection = document.createElement('div');
        majorSection.className = 'ziwei-cycle-section';
        panel.appendChild(majorSection);

        const majorLabel = document.createElement('div');
        majorLabel.className = 'ziwei-cycle-label';
        majorLabel.textContent = '大限';
        majorSection.appendChild(majorLabel);

        const majorRow = document.createElement('div');
        majorRow.className = 'ziwei-cycle-row ziwei-major-cycle-row';
        majorSection.appendChild(majorRow);

        // Annual cycle section
        const annualSection = document.createElement('div');
        annualSection.className = 'ziwei-cycle-section';
        panel.appendChild(annualSection);

        const annualLabel = document.createElement('div');
        annualLabel.className = 'ziwei-cycle-label';
        annualLabel.textContent = '流年(開發中)';
        annualLabel.style.display = 'none';
        annualSection.appendChild(annualLabel);

        const annualRow = document.createElement('div');
        annualRow.className = 'ziwei-cycle-row ziwei-annual-cycle-row';
        annualRow.style.display = 'none';
        annualSection.appendChild(annualRow);

        let activeMajorButton = null;
        let isProcessingCycleClick = false;

        const clearCycleState = () => {
            // Don't clear if we're in the middle of processing a cycle button click
            if (isProcessingCycleClick) {
                console.log('clearCycleState: skipping because cycle click in progress');
                return;
            }
            
            console.log('clearCycleState: clearing all cycle state');
            if (activeMajorButton) {
                activeMajorButton.classList.remove('ziwei-cycle-button-active');
            }
            activeMajorButton = null;
            annualRow.innerHTML = '';
            annualRow.style.display = 'none';
            annualLabel.style.display = 'none';
            window.ziweiChartHelpers?.clearMajorCycleStars?.();
            window.ziweiChartHelpers?.clearMajorCycleMutations?.();
        };

        const highlightPalace = (palaceIndex) => {
            console.log('highlightPalace called:', palaceIndex, 'API available:', typeof palaceInteraction?.highlight);
            if (palaceInteraction && typeof palaceInteraction.highlight === 'function') {
                palaceInteraction.highlight(palaceIndex);
                return;
            }

            // Fallback: find cell and click it
            const fallbackCell = grid.querySelector(`.ziwei-cell[data-branch-index="${palaceIndex}"]`);
            console.log('Fallback cell found:', !!fallbackCell, 'selector:', `.ziwei-cell[data-branch-index="${palaceIndex}"]`);
            if (fallbackCell) {
                fallbackCell.click();
            }
        };

        const getPalaceStemBranch = (palaceIndex) => {
            if (palaceData && palaceData[palaceIndex]) {
                const palace = palaceData[palaceIndex];
                return (palace.stem || '') + (palace.branchZhi || '');
            }
            return '';
        };

        const renderAnnualRow = (cycle) => {
            annualRow.innerHTML = '';

            for (let offset = 0; offset < 10; offset++) {
                const age = cycle.startAge + offset;
                const annualBtn = document.createElement('button');
                annualBtn.type = 'button';
                annualBtn.className = 'ziwei-cycle-button ziwei-annual-cycle-button';
                annualBtn.textContent = `${age}`;
                annualBtn.dataset.age = String(age);
                annualBtn.dataset.cycleIndex = String(cycle.cycleIndex);
                annualRow.appendChild(annualBtn);
            }
            annualRow.style.display = 'grid';
            annualLabel.style.display = 'block';
        };

        const handleMajorCycleSelection = (cycle, stemBranch) => {
            if (!cycle) return;

            const palace = palaceData?.[cycle.palaceIndex] || null;
            const cycleStem = palace?.stem || (stemBranch ? stemBranch.charAt(0) : '');
            const cycleBranchIndex = palace?.index;

            window.ziweiChartHelpers?.showMajorCycleStars?.({ 
                cycle, 
                stem: cycleStem,
                branchIndex: cycleBranchIndex,
                timeIndex: timeIndex,
                palaceData: palaceData
            });
            window.ziweiChartHelpers?.applyMajorCycleMutations?.(cycleStem);
        };

        majorCycles.forEach((cycle) => {
            const stemBranch = getPalaceStemBranch(cycle.palaceIndex);
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'ziwei-cycle-button ziwei-major-cycle-button';
            const labelText = stemBranch ? `${stemBranch}限` : '大限';
            btn.dataset.cycleIndex = String(cycle.cycleIndex);
            btn.dataset.palaceIndex = String(cycle.palaceIndex);
            btn.dataset.ageRange = cycle.ageRange;

            const labelSpan = document.createElement('span');
            labelSpan.className = 'ziwei-cycle-button-label';
            labelSpan.textContent = labelText;
            btn.appendChild(labelSpan);

            const ageSpan = document.createElement('span');
            ageSpan.className = 'ziwei-cycle-button-age';
            ageSpan.textContent = cycle.ageRange;
            btn.appendChild(ageSpan);

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                console.log('Cycle button clicked:', { cycleIndex: cycle.cycleIndex, palaceIndex: cycle.palaceIndex, stemBranch });

                // Set flag to prevent clearCycleState from running during our click handling
                isProcessingCycleClick = true;

                // Remove active class from all buttons first
                const allButtons = majorRow.querySelectorAll('.ziwei-cycle-button');
                allButtons.forEach(b => {
                    b.classList.remove('ziwei-cycle-button-active');
                });

                // Add active class to clicked button
                console.log('Adding active class to button:', stemBranch);
                btn.classList.add('ziwei-cycle-button-active');
                activeMajorButton = btn;
                
                // Verify class was added
                console.log('Button classes after click:', btn.className);
                console.log('Has active class:', btn.classList.contains('ziwei-cycle-button-active'));

                highlightPalace(cycle.palaceIndex);
                renderAnnualRow(cycle);
                handleMajorCycleSelection(cycle, stemBranch);

                // Reset flag after a short delay to allow palace highlight to complete
                setTimeout(() => {
                    isProcessingCycleClick = false;
                }, 100);
            });

            majorRow.appendChild(btn);
        });

        // Hook into palace interaction to clear cycle state when clicking center
        if (grid && palaceInteraction && typeof palaceInteraction.onClear === 'function') {
            console.log('Registering onClear callback');
            palaceInteraction.onClear(() => {
                console.log('onClear callback invoked');
                clearCycleState();
            });
        } else if (grid) {
            console.log('Fallback: registering grid click handler');
            // Fallback: listen for center cell clicks
            grid.addEventListener('click', (e) => {
                const cellElement = e.target.closest('.ziwei-cell');
                if (!cellElement || cellElement.classList.contains('ziwei-center-big')) {
                    console.log('Center cell clicked, clearing state');
                    clearCycleState();
                }
            });
        }

        return panel;
    }

    window.ziweiCycles = {
        initializeCyclePanel
    };
})();

